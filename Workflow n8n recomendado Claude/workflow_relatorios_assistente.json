{
  "name": "Assistente Desenvolvimento Pessoal - Relat√≥rios",
  "nodes": [
    {
      "parameters": {
        "rule": {
          "interval": [
            {
              "field": "cronExpression",
              "expression": "0 19 * * 0"
            }
          ]
        }
      },
      "id": "cron-weekly-report",
      "name": "Cron - Relat√≥rio Semanal (Domingo 19h)",
      "type": "n8n-nodes-base.cron",
      "typeVersion": 1,
      "position": [140, 200]
    },
    {
      "parameters": {
        "rule": {
          "interval": [
            {
              "field": "cronExpression",
              "expression": "0 20 28-31 * *"
            }
          ]
        }
      },
      "id": "cron-monthly-report",
      "name": "Cron - Relat√≥rio Mensal (√öltimo dia 20h)",
      "type": "n8n-nodes-base.cron",
      "typeVersion": 1,
      "position": [140, 500]
    },
    {
      "parameters": {
        "operation": "select",
        "table": "users",
        "where": {
          "conditions": [
            {
              "column": "onboarding_completed",
              "operator": "=",
              "value": true
            }
          ]
        }
      },
      "id": "get-active-users-weekly",
      "name": "Get Active Users (Weekly)",
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [360, 200],
      "credentials": {
        "supabaseApi": {
          "id": "supabase-credential",
          "name": "Supabase Foquinha AI"
        }
      }
    },
    {
      "parameters": {
        "operation": "select",
        "table": "users",
        "where": {
          "conditions": [
            {
              "column": "onboarding_completed",
              "operator": "=",
              "value": true
            }
          ]
        }
      },
      "id": "get-active-users-monthly",
      "name": "Get Active Users (Monthly)",
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [360, 500],
      "credentials": {
        "supabaseApi": {
          "id": "supabase-credential",
          "name": "Supabase Foquinha AI"
        }
      }
    },
    {
      "parameters": {
        "batchSize": 1,
        "options": {}
      },
      "id": "loop-users-weekly",
      "name": "Loop Users (Weekly)",
      "type": "n8n-nodes-base.splitInBatches",
      "typeVersion": 1,
      "position": [580, 200]
    },
    {
      "parameters": {
        "batchSize": 1,
        "options": {}
      },
      "id": "loop-users-monthly",
      "name": "Loop Users (Monthly)",
      "type": "n8n-nodes-base.splitInBatches",
      "typeVersion": 1,
      "position": [580, 500]
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT \n  h.id, h.name,\n  COUNT(CASE WHEN hl.completed = true THEN 1 END) as completed_count,\n  COUNT(hl.id) as total_logs,\n  ROUND(COUNT(CASE WHEN hl.completed = true THEN 1 END) * 100.0 / NULLIF(COUNT(hl.id), 0), 1) as completion_rate\nFROM habits h\nLEFT JOIN habit_logs hl ON h.id = hl.habit_id \n  AND hl.date >= CURRENT_DATE - INTERVAL '7 days'\nWHERE h.user_id = {{ $json.id }} \n  AND h.is_active = true\nGROUP BY h.id, h.name\nORDER BY completion_rate DESC"
      },
      "id": "get-weekly-data",
      "name": "Get Weekly Data",
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [800, 200],
      "credentials": {
        "supabaseApi": {
          "id": "supabase-credential",
          "name": "Supabase Foquinha AI"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT \n  h.id, h.name,\n  COUNT(CASE WHEN hl.completed = true THEN 1 END) as completed_count,\n  COUNT(hl.id) as total_logs,\n  ROUND(COUNT(CASE WHEN hl.completed = true THEN 1 END) * 100.0 / NULLIF(COUNT(hl.id), 0), 1) as completion_rate,\n  -- Calcular tend√™ncia (comparar √∫ltimas 2 semanas vs 2 semanas anteriores)\n  (\n    SELECT ROUND(COUNT(CASE WHEN hl2.completed = true THEN 1 END) * 100.0 / NULLIF(COUNT(hl2.id), 0), 1)\n    FROM habit_logs hl2 \n    WHERE hl2.habit_id = h.id \n      AND hl2.date >= CURRENT_DATE - INTERVAL '14 days'\n      AND hl2.date < CURRENT_DATE - INTERVAL '7 days'\n  ) as previous_rate\nFROM habits h\nLEFT JOIN habit_logs hl ON h.id = hl.habit_id \n  AND hl.date >= CURRENT_DATE - INTERVAL '30 days'\nWHERE h.user_id = {{ $json.id }} \n  AND h.is_active = true\nGROUP BY h.id, h.name\nORDER BY completion_rate DESC"
      },
      "id": "get-monthly-data",
      "name": "Get Monthly Data",
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [800, 500],
      "credentials": {
        "supabaseApi": {
          "id": "supabase-credential",
          "name": "Supabase Foquinha AI"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// Gerar relat√≥rio semanal personalizado\nconst user = $input.all()[0];\nconst habitsData = $input.all()[1];\n\nconst userName = user.name || 'Guerreiro(a)';\nconst totalHabits = habitsData.length;\n\nlet reportContent = `‚ú® **SEU RELAT√ìRIO SEMANAL** ‚ú®\\n\\nOl√° ${userName}! Aqui est√° um resumo da sua semana:\\n\\n`;\n\n// Calcular estat√≠sticas gerais\nlet totalCompletions = 0;\nlet totalPossible = 0;\nlet bestHabit = null;\nlet worstHabit = null;\nlet bestRate = 0;\nlet worstRate = 100;\n\nhabitsData.forEach(habit => {\n  const rate = habit.completion_rate || 0;\n  totalCompletions += habit.completed_count || 0;\n  totalPossible += habit.total_logs || 0;\n  \n  if (rate > bestRate) {\n    bestRate = rate;\n    bestHabit = habit;\n  }\n  \n  if (rate < worstRate && rate > 0) {\n    worstRate = rate;\n    worstHabit = habit;\n  }\n});\n\nconst overallRate = totalPossible > 0 ? Math.round((totalCompletions / totalPossible) * 100) : 0;\n\n// Adicionar estat√≠sticas por h√°bito\nreportContent += `üìä **DESEMPENHO GERAL:** ${overallRate}%\\n\\n`;\n\nhabitsData.forEach(habit => {\n  const rate = habit.completion_rate || 0;\n  const emoji = rate >= 80 ? 'üî•' : rate >= 60 ? 'üí™' : rate >= 40 ? 'üìà' : 'üå±';\n  reportContent += `${emoji} **${habit.name}:** ${rate}% (${habit.completed_count}/${habit.total_logs})\\n`;\n});\n\n// Mensagem motivacional baseada no desempenho\nlet motivationalMessage;\nif (overallRate >= 80) {\n  motivationalMessage = `üéâ **PARAB√âNS!** Voc√™ est√° arrasando! Continue assim, ${userName}! Sua consist√™ncia √© inspiradora! üöÄ`;\n} else if (overallRate >= 60) {\n  motivationalMessage = `üí™ **MUITO BEM!** Voc√™ est√° no caminho certo! Alguns ajustes e voc√™ vai alcan√ßar a excel√™ncia! üìà`;\n} else if (overallRate >= 40) {\n  motivationalMessage = `üå± **CRESCENDO!** Toda jornada tem seus desafios. O importante √© n√£o desistir! Voc√™ consegue! üíé`;\n} else {\n  motivationalMessage = `ü§ó **JUNTOS NESSA!** N√£o desanime! Grandes transforma√ß√µes come√ßam com pequenos passos. Vamos ajustar seu plano! ‚ú®`;\n}\n\nreportContent += `\\n${motivationalMessage}\\n\\n`;\n\n// Destaque da semana\nif (bestHabit && bestRate > 0) {\n  reportContent += `üèÜ **DESTAQUE DA SEMANA:** ${bestHabit.name} com ${bestRate}%!\\n\\n`;\n}\n\n// Sugest√£o para pr√≥xima semana\nif (worstHabit && worstRate < 60) {\n  reportContent += `üéØ **FOCO PARA PR√ìXIMA SEMANA:** Vamos dar aten√ß√£o especial ao \"${worstHabit.name}\". Que tal ajustarmos os hor√°rios?\\n\\n`;\n}\n\nreportContent += `Qual ser√° nosso foco para a pr√≥xima semana? Estou aqui para te ajudar! üí´\\n\\n_Enviado com ‚ù§Ô∏è pelo seu assistente pessoal_`;\n\nreturn [{\n  json: {\n    user_id: user.id,\n    phone: user.phone,\n    name: userName,\n    report_content: reportContent,\n    overall_rate: overallRate,\n    report_type: 'weekly'\n  }\n}];"
      },
      "id": "generate-weekly-report",
      "name": "Generate Weekly Report",
      "type": "n8n-nodes-base.code",
      "typeVersion": 1,
      "position": [1020, 200]
    },
    {
      "parameters": {
        "jsCode": "// Gerar relat√≥rio mensal detalhado\nconst user = $input.all()[0];\nconst habitsData = $input.all()[1];\n\nconst userName = user.name || 'Guerreiro(a)';\n\nlet reportContent = `üåü **SEU RELAT√ìRIO MENSAL** üåü\\n\\nOl√° ${userName}! Aqui est√° sua jornada do √∫ltimo m√™s:\\n\\n`;\n\n// Calcular estat√≠sticas e tend√™ncias\nlet improvingHabits = [];\nlet decliningHabits = [];\nlet stableHabits = [];\n\nhabitsData.forEach(habit => {\n  const currentRate = habit.completion_rate || 0;\n  const previousRate = habit.previous_rate || 0;\n  \n  const trendEmoji = currentRate > previousRate + 5 ? 'üìà' : \n                    currentRate < previousRate - 5 ? 'üìâ' : '‚û°Ô∏è';\n  \n  const habitSummary = {\n    name: habit.name,\n    rate: currentRate,\n    previousRate: previousRate,\n    trend: trendEmoji,\n    completed: habit.completed_count\n  };\n  \n  if (currentRate > previousRate + 5) {\n    improvingHabits.push(habitSummary);\n  } else if (currentRate < previousRate - 5) {\n    decliningHabits.push(habitSummary);\n  } else {\n    stableHabits.push(habitSummary);\n  }\n});\n\n// Estat√≠sticas por h√°bito\nreportContent += `üìä **DESEMPENHO POR H√ÅBITO:**\\n\\n`;\n\nhabitsData.forEach(habit => {\n  const rate = habit.completion_rate || 0;\n  const previousRate = habit.previous_rate || 0;\n  const trend = rate > previousRate + 5 ? 'üìà' : \n               rate < previousRate - 5 ? 'üìâ' : '‚û°Ô∏è';\n  const emoji = rate >= 80 ? 'üî•' : rate >= 60 ? 'üí™' : rate >= 40 ? 'üìà' : 'üå±';\n  \n  reportContent += `${emoji} **${habit.name}**: ${rate}% ${trend}\\n`;\n  reportContent += `   ‚îî Completou ${habit.completed_count} vezes no m√™s\\n\\n`;\n});\n\n// An√°lise de tend√™ncias\nif (improvingHabits.length > 0) {\n  reportContent += `üöÄ **H√ÅBITOS EM ASCENS√ÉO:**\\n`;\n  improvingHabits.forEach(habit => {\n    reportContent += `‚Ä¢ ${habit.name}: ${habit.previousRate}% ‚Üí ${habit.rate}%\\n`;\n  });\n  reportContent += `\\n`;\n}\n\nif (decliningHabits.length > 0) {\n  reportContent += `‚ö†Ô∏è **PRECISAM DE ATEN√á√ÉO:**\\n`;\n  decliningHabits.forEach(habit => {\n    reportContent += `‚Ä¢ ${habit.name}: ${habit.previousRate}% ‚Üí ${habit.rate}%\\n`;\n  });\n  reportContent += `\\n`;\n}\n\n// Insights e sugest√µes\nreportContent += `üí° **INSIGHTS E SUGEST√ïES:**\\n\\n`;\n\nif (improvingHabits.length >= decliningHabits.length) {\n  reportContent += `üéØ Voc√™ est√° evoluindo! ${improvingHabits.length} h√°bito(s) melhoraram significativamente.\\n\\n`;\n  reportContent += `üìÖ **Sugest√£o:** Continue com a estrat√©gia atual e considere ajustar os hor√°rios dos h√°bitos que precisam de aten√ß√£o.\\n\\n`;\n} else {\n  reportContent += `üîÑ Hora de revisar! Vamos ajustar a estrat√©gia para os pr√≥ximos 30 dias.\\n\\n`;\n  reportContent += `üìÖ **Sugest√£o:** Que tal simplificarmos alguns h√°bitos e focarmos na consist√™ncia?\\n\\n`;\n}\n\n// Chamada para a√ß√£o\nreportContent += `üéØ **PR√ìXIMOS 30 DIAS:**\\nVamos definir juntos suas prioridades para o pr√≥ximo m√™s. Me mande uma mensagem e vamos criar um plano ainda mais eficiente!\\n\\n`;\n\nreportContent += `Lembre-se: grandes transforma√ß√µes acontecem com pequenos passos consistentes! üí™‚ú®\\n\\n_Enviado com ‚ù§Ô∏è pelo seu assistente pessoal_`;\n\nreturn [{\n  json: {\n    user_id: user.id,\n    phone: user.phone,\n    name: userName,\n    report_content: reportContent,\n    improving_habits: improvingHabits.length,\n    declining_habits: decliningHabits.length,\n    report_type: 'monthly'\n  }\n}];"
      },
      "id": "generate-monthly-report",
      "name": "Generate Monthly Report",
      "type": "n8n-nodes-base.code",
      "typeVersion": 1,
      "position": [1020, 500]
    },
    {
      "parameters": {
        "to": "={{ $json.phone }}",
        "message": "={{ $json.report_content }}",
        "options": {}
      },
      "id": "send-weekly-report",
      "name": "Send Weekly Report",
      "type": "n8n-nodes-base.whatsAppBusinessCloud",
      "typeVersion": 1,
      "position": [1240, 200],
      "credentials": {
        "whatsAppBusinessCloudApi": {
          "id": "whatsapp-send-credential",
          "name": "WhatsApp Business Cloud Send"
        }
      }
    },
    {
      "parameters": {
        "to": "={{ $json.phone }}",
        "message": "={{ $json.report_content }}",
        "options": {}
      },
      "id": "send-monthly-report",
      "name": "Send Monthly Report",
      "type": "n8n-nodes-base.whatsAppBusinessCloud",
      "typeVersion": 1,
      "position": [1240, 500],
      "credentials": {
        "whatsAppBusinessCloudApi": {
          "id": "whatsapp-send-credential",
          "name": "WhatsApp Business Cloud Send"
        }
      }
    },
    {
      "parameters": {
        "operation": "insert",
        "table": "conversations",
        "fields": {
          "user_id": "={{ $json.user_id }}",
          "message": "{{ $json.report_content }}",
          "sender": "assistant",
          "timestamp": "={{ new Date().toISOString() }}",
          "context": "{{ JSON.stringify({ type: $json.report_type + '_report', overall_rate: $json.overall_rate || null, improving_habits: $json.improving_habits || null, declining_habits: $json.declining_habits || null }) }}"
        }
      },
      "id": "log-weekly-report",
      "name": "Log Weekly Report",
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [1460, 200],
      "credentials": {
        "supabaseApi": {
          "id": "supabase-credential",
          "name": "Supabase Foquinha AI"
        }
      }
    },
    {
      "parameters": {
        "operation": "insert",
        "table": "conversations",
        "fields": {
          "user_id": "={{ $json.user_id }}",
          "message": "{{ $json.report_content }}",
          "sender": "assistant",
          "timestamp": "={{ new Date().toISOString() }}",
          "context": "{{ JSON.stringify({ type: $json.report_type + '_report', improving_habits: $json.improving_habits, declining_habits: $json.declining_habits }) }}"
        }
      },
      "id": "log-monthly-report",
      "name": "Log Monthly Report",
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [1460, 500],
      "credentials": {
        "supabaseApi": {
          "id": "supabase-credential",
          "name": "Supabase Foquinha AI"
        }
      }
    }
  ],
  "connections": {
    "Cron - Relat√≥rio Semanal (Domingo 19h)": {
      "main": [
        [
          {
            "node": "Get Active Users (Weekly)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Cron - Relat√≥rio Mensal (√öltimo dia 20h)": {
      "main": [
        [
          {
            "node": "Get Active Users (Monthly)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get Active Users (Weekly)": {
      "main": [
        [
          {
            "node": "Loop Users (Weekly)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get Active Users (Monthly)": {
      "main": [
        [
          {
            "node": "Loop Users (Monthly)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Loop Users (Weekly)": {
      "main": [
        [
          {
            "node": "Get Weekly Data",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Loop Users (Monthly)": {
      "main": [
        [
          {
            "node": "Get Monthly Data",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get Weekly Data": {
      "main": [
        [
          {
            "node": "Generate Weekly Report",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get Monthly Data": {
      "main": [
        [
          {
            "node": "Generate Monthly Report",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Generate Weekly Report": {
      "main": [
        [
          {
            "node": "Send Weekly Report",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Generate Monthly Report": {
      "main": [
        [
          {
            "node": "Send Monthly Report",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Send Weekly Report": {
      "main": [
        [
          {
            "node": "Log Weekly Report",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Send Monthly Report": {
      "main": [
        [
          {
            "node": "Log Monthly Report",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": false,
  "settings": {},
  "versionId": "2.0.0",
  "meta": {
    "templateCredsSetupCompleted": false
  },
  "id": "assistente-desenvolvimento-pessoal-relatorios",
  "tags": [
    "WhatsApp",
    "Relat√≥rios",
    "Analytics",
    "Supabase",
    "Cron"
  ]
}